<!DOCTYPE html><html lang="zh-TW" prefix="og: http://ogp.me/ns#"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="UTF-8">
<meta name="author" property="og:article:author" content="gholk">
<meta name="copyright" content="Common Creative">
<meta name="generator" content="emacs, markdown">
<!-- 以上一般不用改，以下才要改。 -->

<!-- 後設資料 -->
<meta name="date" property="og:article:public_time" content="2018-03-15T12:52:05.029Z">
<meta name="keywords" property="og:article:tag" content="bbsjs,ptt,javascript,browser,bbs,user-js,bookmarklet">
<link rel="index" type="text/html" href="index.html" title="首頁">
<link rel="start" type="text/html" href="index.html" title="首頁">
<link rel="next" type="text/html" href="ccns-vice-president-experience.html" title="ccns 副社長經驗">
<link rel="prev" type="text/html" href="geomatics-measuring-the-world.html" title="工程倫理的丈量世界心得">

<!-- 和網頁位置有關 -->
<link rel="icon" type="image/png" href="ext/icon.png">
<link rel="apple-touch-icon" type="image/png" href="ext/icon.png">
<link rel="stylesheet" type="text/css" href="ext/padding-lot.css">

<script src="ext/meta-bloging.js"></script>

<title>BBSJS 原型概念版</title>
</head>
<body>
<main><h1 id="BBSJS-原型概念版">BBSJS 原型概念版</h1>
<p>BBSJS 是由 BBSLua 啟發，在用測覽器上 ptt 時，
執行 ptt 文章內 javascript 的計劃。</p>
<script src="ext/toc.js"></script>

<h2 id="使用方法">使用方法</h2>
<p>在文章內按 J 即可執行文內的 bbsjs；
如果是用小書籤，就是直接在文章內點擊小書籤執行。
目前可以在 ptt chrome、term.ptt.cc 或其它類似介面下使用，
ptt 網頁版也可以動。</p>
<p>使用 ptt chrome、term.ptt.cc 等，
建議在 ptt chrome 內右鍵，開啟選項內的好讀模式，
讓 bbsjs 就算超過一頁，也能一次全部載入執行。</p>
<h2 id="安裝">安裝</h2>
<p>目前發布 <a href="http://zh.wikipedia.org/wiki/%E5%B0%8F%E6%9B%B8%E7%B1%A4">小書籤</a> bookmarklet 和 <a href="http://zh.wikipedia.org/wiki/Greasemonkey">Greasemonkey</a> 腳本二種執行方法。
grease monkey 是一種簡易的瀏覽器腳本，安裝後在特定的網域執行。
小書籤則是類似書籤，只是點擊時不是前往該網站，而是在現在頁面下執行程式。</p>
<h3 id="grease-monkey">grease monkey</h3>
<p>需安裝 grease monkey，chrome 下可以試 Tampermonkey，
<a href="https://github.com/GHolk/bookmarklet/blob/9f7671fb7c98cacb869d8ca9a85764d042d2678e/bbsjs.user.js">user script 拖管在 github 上</a> ，
在 github 上 <a href="https://github.com/GHolk/bookmarklet/raw/9f7671fb7c98cacb869d8ca9a85764d042d2678e/bbsjs.user.js">點擊 raw 可以安裝</a> 。</p>
<h3 id="小書籤-bookmarklet">小書籤 bookmarklet</h3>
<p>請在下文的 bbs 小書籤超連結上按右鍵加入書籤，
或是用拖曳的方式將超連結放到書籤列中：</p>
<p><a href="javascript:void%20function%20%28%29%20%7Bfunction%20promptJe%28%29%7B%28new%20JavascriptEvalator%29.prompt%28%29%7Dfunction%20registJe%28listen%29%7Bwindow.addEventListener%28%22keydown%22%2Cdown%3D%3E%7Bif%28listen%28down%29%29try%7BpromptJe%28%29%7Dcatch%28bbsjsError%29%7Bconsole.error%28bbsjsError%29%7D%7D%29%7Dfunction%20assureBbsjsFrame%28%29%7B%24%28%22%23bbsjs-container%22%29%7C%7CinitBbsjsFrame%28%29%7Dfunction%20initBbsjsFrame%28%29%7Bconst%20div%3Ddocument.createElement%28%22div%22%29%3Bdiv.id%3D%22bbsjs-container%22%3Bconst%20homePageUrl%3D%22https%3A%2F%2Fgholk.github.io%2Fbbsjs.html%22%3Bdiv.innerHTML%3D%60%5Cn%3Cbutton%3Emove%3C%2Fbutton%3E%5Cn%3Cbutton%3Eexecute%3C%2Fbutton%3E%5Cn%3Ca%20href%3D%22%24%7BhomePageUrl%7D%22%20target%3D%22bbsjs-iframe%22%3Ehelp%3C%2Fa%3E%5Cn%3Ciframe%20name%3D%22bbsjs-iframe%22%20src%3D%22%24%7BhomePageUrl%7D%22%3E%3C%2Fiframe%3E%5Cn%3Cstyle%3E%5Cn%5Cn%23bbsjs-container%20%7B%5Cn%20%20transition%3A%200.5s%3B%5Cn%20%20position%3A%20fixed%3B%5Cn%20%20top%3A%201em%3B%5Cn%20%20left%3A%201em%3B%5Cn%20%20z-index%3A%202%3B%5Cn%20%20background%3A%20white%3B%5Cn%7D%5Cn%23bbsjs-container%20%2A%20%7B%5Cn%20%20display%3A%20none%3B%5Cn%7D%5Cn%23bbsjs-container%20button%20%7B%5Cn%20%20display%3A%20inline%3B%5Cn%20%20margin%3A%200.5em%3B%5Cn%20%20color%3A%20black%3B%5Cn%7D%5Cn%23bbsjs-container.show%20iframe%20%7B%5Cn%20%20border%3A%20none%3B%5Cn%20%20clear%3A%20both%3B%5Cn%20%20display%3A%20block%3B%5Cn%20%20width%3A%20100%25%3B%5Cn%20%20height%3A%2025em%3B%5Cn%7D%5Cn%23bbsjs-container.show%20a%20%7B%5Cn%20%20display%3A%20inline%3B%5Cn%7D%5Cn%23bbsjs-container.show%20%7B%5Cn%20%20transition%3A%200.5s%3B%5Cn%20%20width%3A%2040%25%3B%5Cn%20%20top%3A%202em%3B%5Cn%20%20left%3A%2030%25%3B%5Cn%20%20z-index%3A%202%3B%5Cn%7D%5Cn%3C%2Fstyle%3E%5Cn%60%2Cwindow.addEventListener%28%22click%22%2Cclick%3D%3E%7Bconst%20button%3Dclick.target%3Bif%28button.matches%28%22%23bbsjs-container%20button%22%29%29if%28%22move%22%3D%3Dbutton.textContent%29%7Bbutton.parentNode.classList.toggle%28%22show%22%29%7Delse%20if%28%22execute%22%3D%3Dbutton.textContent%29try%7BpromptJe%28%29%7Dcatch%28bbsjsError%29%7Bconsole.error%28bbsjsError%29%7D%7D%29%2Cdocument.body.append%28div%29%7Dconst%20%24%3De%3D%3Edocument.querySelector%28e%29%3Bclass%20JavascriptEvalator%7Bconstructor%28%29%7BassureBbsjsFrame%28%29%7Dprompt%28%29%7Bconst%20script%3Dthis.getScript%28%29%3Bthis.execute%28script%29%7DgetArticle%28%29%7Breturn%20location.href.match%28%22www.ptt.cc%22%29%3Fthis.getPttWebArticle%28%29%3Athis.getPttChromeArticle%28%29%7DgetPttWebArticle%28%29%7Breturn%20%24%28%22%23main-container%22%29.textContent%7DgetPttChromeArticle%28%29%7Breturn%20Array.from%28%24%28%22%23mainContainer%22%29.children%29.map%28row%3D%3Erow.textContent%29.join%28%22%5Cn%22%29%7DgetScript%28%29%7Bconst%20article%3Dthis.getArticle%28%29%2Chtml%3Darticle.match%28%2F%3Chtml%5B%5CS%5Cs%5D%2A%3F%3C%5C%2Fhtml%3E%2F%29%2Cscript%3Darticle.match%28%2F%3Cscript%5B%5CS%5Cs%5D%2A%3F%3C%5C%2Fscript%3E%2F%29%3Bif%28html%29return%20html%5B0%5D%3Bif%28script%29return%20script%5B0%5D%3Bthrow%20new%20Error%28%22no%20bbsjs%20script%20found%22%29%7Dexecute%28script%29%7Breturn%20this.iframeObjectUrlExecute%28script%29%7DiframeObjectUrlExecute%28script%29%7Bconst%20scriptFile%3Dnew%20File%28%5Bscript%5D%2C%22bbsjs-frame.html%22%2C%7Btype%3A%22text%2Fhtml%22%7D%29%2CscriptUrl%3DURL.createObjectURL%28scriptFile%29%3B%24%28%22%23bbsjs-container%20iframe%22%29.src%3DscriptUrl%2CURL.revokeObjectURL%28scriptFile%29%2C%24%28%22%23bbsjs-container%22%29.classList.add%28%22show%22%29%7DevalExecute%28script%29%7Bconst%20cleanScript%3Dscript.replace%28%2F%5E%3Cscript%5B%5CS%5Cs%5D%2A%3F%3E%2F%2C%22%22%29.replace%28%2F%3C%5C%2Fscript%3E%24%2F%2C%22%22%29%3Breturn%20eval%28cleanScript%29%7DwindowExecute%28script%29%7Bconst%20scriptWindow%3Dwindow.open%28%22about%3Ablank%22%29%2CscriptDocument%3DscriptWindow.document%3Breturn%20scriptDocument.write%28script%29%2CscriptDocument.close%28%29%2CscriptWindow%7DiframeExecute%28script%29%7B%24%28%22%23bbsjs-container%22%29.classList.add%28%22show%22%29%3Bconst%20iframe%3D%24%28%22%23bbsjs-container%20iframe%22%29%3Breturn%20iframe.contentDocument.write%28script%29%2Ciframe.contentDocument.close%28%29%2Ciframe%7D%7D%22undefined%22%21%3Dtypeof%20GM%3FregistJe%28keydown%3D%3E%22J%22%3D%3Dkeydown.key%29%3ApromptJe%28%29%2CassureBbsjsFrame%28%29%3B%7D%28%29" title="bbsjs">bbsjs 小書籤超連結</a></p>
<h2 id="bbsjs-api">bbsjs api</h2>
<p>bbsjs 會抓取文章內第一個 script 或 html 標籤，
整個寫入到 iframe 中，如同把 script 存成 html 檔後開啟，
並在網頁裡執行 script 內容。</p>
<p>裡面可以用 document.write、alert confirm prompt，
甚至操作 dom，與使用者互動。</p>
<pre><code class="lang-html">&lt;script&gt; 
/* javascript */
alert(&apos;hello world!&apos;)
var username = prompt(&apos;what is your name?&apos;)
document.write(&apos;good bye &apos; + username)
&lt;/script&gt;
</code></pre>
<p>如果是 <code>&lt;html&gt;</code> 可以直接寫 html 元素，
甚至用 <code>&lt;script src=&quot;https://some.script&quot;&gt;</code> 引入其它 javascript，
就和平常寫網頁一樣。</p>
<pre><code class="lang-html">&lt;html&gt;
&lt;meta charset=&quot;utf-8&quot;&gt;

&lt;pre id=&quot;markdown-raw&quot;&gt;
# write your markdown here
this **markdown** is power by [gholk/marked] .

[gholk/marked]: http://github.com/gholk/marked/
&lt;/pre&gt;

&lt;div id=&quot;markdown-html&quot;&gt;&lt;/div&gt;

&lt;script src=&quot;https://gholk.github.io/marked/marked.min.js&quot;&gt;&lt;/script&gt;
&lt;script&gt;
  const raw = document.querySelector(&apos;#markdown-raw&apos;).textContent
  const html = marked(raw)
  document.querySelector(&apos;#markdown-html&apos;).innerHTML = html
&lt;/script&gt;
&lt;/html&gt;
</code></pre>
<p>要用 ajax 的話要設好 cors，
在 iframe 的 context 裡沒有任何網址是 same origin。
（自己 document.write(location.href) 就知道了。）
要注意是網址不要簡寫成 <code>src=&quot;//some.script&quot;</code> ，
因為該 iframe scheme 是在 <code>blob:</code> ，要寫 <code>https://</code> 。</p>
<h2 id="範例程式">範例程式</h2>
<ul>
<li><a href="https://www.ptt.cc/bbs/PttWeb/M.1521126610.A.A07.html">在 PttWeb 板的介紹文兼簡單的程式</a></li>
<li>ptt 測試板 test 裡有幾篇，搜 bbsjs 就有了。
但一周後會被清掉，就不放網址了。</li>
<li>個人站 <a href="http://clam.ml">http://clam.ml</a> 的 test 板裡有幾篇示範程式，被 m 了應該不會被清。 --&gt;</li>
</ul>
<h2 id="版本歷程">版本歷程</h2>
<p>以下各標題為版本名，版本從新排到舊排列。</p>
<p>目前版本都沒有和 ptt chrome 互動，
是直接從 html 裡抓出文章內的 script，
再用 css 把執行結果放在頁面中央。
未來期望可以整合進 ptt chrome，
把 script 執行結果直接插到 ptt chrome 的好讀版內。</p>
<h3 id="jquery-bye">jquery bye</h3>
<p>移除 jquery 直接使用 <code>document.querySelector</code> ，
greasemonkey 使用頁面內自帶的 jquery 的話好像有 scope 問題，
移除就沒問題了。</p>
<ul>
<li><a href="https://github.com/GHolk/bookmarklet/blob/9f7671fb7c98cacb869d8ca9a85764d042d2678e/bbsjs.user.js">油猴腳本</a> 與
<a href="https://github.com/GHolk/bookmarklet/raw/9f7671fb7c98cacb869d8ca9a85764d042d2678e/bbsjs.user.js">安裝油猴腳本</a></li>
<li><a href="javascript:void%20function%20%28%29%20%7Bfunction%20promptJe%28%29%7B%28new%20JavascriptEvalator%29.prompt%28%29%7Dfunction%20registJe%28listen%29%7Bwindow.addEventListener%28%22keydown%22%2Cdown%3D%3E%7Bif%28listen%28down%29%29try%7BpromptJe%28%29%7Dcatch%28bbsjsError%29%7Bconsole.error%28bbsjsError%29%7D%7D%29%7Dfunction%20assureBbsjsFrame%28%29%7B%24%28%22%23bbsjs-container%22%29%7C%7CinitBbsjsFrame%28%29%7Dfunction%20initBbsjsFrame%28%29%7Bconst%20div%3Ddocument.createElement%28%22div%22%29%3Bdiv.id%3D%22bbsjs-container%22%3Bconst%20homePageUrl%3D%22https%3A%2F%2Fgholk.github.io%2Fbbsjs.html%22%3Bdiv.innerHTML%3D%60%5Cn%3Cbutton%3Emove%3C%2Fbutton%3E%5Cn%3Cbutton%3Eexecute%3C%2Fbutton%3E%5Cn%3Ca%20href%3D%22%24%7BhomePageUrl%7D%22%20target%3D%22bbsjs-iframe%22%3Ehelp%3C%2Fa%3E%5Cn%3Ciframe%20name%3D%22bbsjs-iframe%22%20src%3D%22%24%7BhomePageUrl%7D%22%3E%3C%2Fiframe%3E%5Cn%3Cstyle%3E%5Cn%5Cn%23bbsjs-container%20%7B%5Cn%20%20transition%3A%200.5s%3B%5Cn%20%20position%3A%20fixed%3B%5Cn%20%20top%3A%201em%3B%5Cn%20%20left%3A%201em%3B%5Cn%20%20z-index%3A%202%3B%5Cn%20%20background%3A%20white%3B%5Cn%7D%5Cn%23bbsjs-container%20%2A%20%7B%5Cn%20%20display%3A%20none%3B%5Cn%7D%5Cn%23bbsjs-container%20button%20%7B%5Cn%20%20display%3A%20inline%3B%5Cn%20%20margin%3A%200.5em%3B%5Cn%20%20color%3A%20black%3B%5Cn%7D%5Cn%23bbsjs-container.show%20iframe%20%7B%5Cn%20%20border%3A%20none%3B%5Cn%20%20clear%3A%20both%3B%5Cn%20%20display%3A%20block%3B%5Cn%20%20width%3A%20100%25%3B%5Cn%20%20height%3A%2025em%3B%5Cn%7D%5Cn%23bbsjs-container.show%20a%20%7B%5Cn%20%20display%3A%20inline%3B%5Cn%7D%5Cn%23bbsjs-container.show%20%7B%5Cn%20%20transition%3A%200.5s%3B%5Cn%20%20width%3A%2040%25%3B%5Cn%20%20top%3A%202em%3B%5Cn%20%20left%3A%2030%25%3B%5Cn%20%20z-index%3A%202%3B%5Cn%7D%5Cn%3C%2Fstyle%3E%5Cn%60%2Cwindow.addEventListener%28%22click%22%2Cclick%3D%3E%7Bconst%20button%3Dclick.target%3Bif%28button.matches%28%22%23bbsjs-container%20button%22%29%29if%28%22move%22%3D%3Dbutton.textContent%29%7Bbutton.parentNode.classList.toggle%28%22show%22%29%7Delse%20if%28%22execute%22%3D%3Dbutton.textContent%29try%7BpromptJe%28%29%7Dcatch%28bbsjsError%29%7Bconsole.error%28bbsjsError%29%7D%7D%29%2Cdocument.body.append%28div%29%7Dconst%20%24%3De%3D%3Edocument.querySelector%28e%29%3Bclass%20JavascriptEvalator%7Bconstructor%28%29%7BassureBbsjsFrame%28%29%7Dprompt%28%29%7Bconst%20script%3Dthis.getScript%28%29%3Bthis.execute%28script%29%7DgetArticle%28%29%7Breturn%20location.href.match%28%22www.ptt.cc%22%29%3Fthis.getPttWebArticle%28%29%3Athis.getPttChromeArticle%28%29%7DgetPttWebArticle%28%29%7Breturn%20%24%28%22%23main-container%22%29.textContent%7DgetPttChromeArticle%28%29%7Breturn%20Array.from%28%24%28%22%23mainContainer%22%29.children%29.map%28row%3D%3Erow.textContent%29.join%28%22%5Cn%22%29%7DgetScript%28%29%7Bconst%20article%3Dthis.getArticle%28%29%2Chtml%3Darticle.match%28%2F%3Chtml%5B%5CS%5Cs%5D%2A%3F%3C%5C%2Fhtml%3E%2F%29%2Cscript%3Darticle.match%28%2F%3Cscript%5B%5CS%5Cs%5D%2A%3F%3C%5C%2Fscript%3E%2F%29%3Bif%28html%29return%20html%5B0%5D%3Bif%28script%29return%20script%5B0%5D%3Bthrow%20new%20Error%28%22no%20bbsjs%20script%20found%22%29%7Dexecute%28script%29%7Breturn%20this.iframeObjectUrlExecute%28script%29%7DiframeObjectUrlExecute%28script%29%7Bconst%20scriptFile%3Dnew%20File%28%5Bscript%5D%2C%22bbsjs-frame.html%22%2C%7Btype%3A%22text%2Fhtml%22%7D%29%2CscriptUrl%3DURL.createObjectURL%28scriptFile%29%3B%24%28%22%23bbsjs-container%20iframe%22%29.src%3DscriptUrl%2CURL.revokeObjectURL%28scriptFile%29%2C%24%28%22%23bbsjs-container%22%29.classList.add%28%22show%22%29%7DevalExecute%28script%29%7Bconst%20cleanScript%3Dscript.replace%28%2F%5E%3Cscript%5B%5CS%5Cs%5D%2A%3F%3E%2F%2C%22%22%29.replace%28%2F%3C%5C%2Fscript%3E%24%2F%2C%22%22%29%3Breturn%20eval%28cleanScript%29%7DwindowExecute%28script%29%7Bconst%20scriptWindow%3Dwindow.open%28%22about%3Ablank%22%29%2CscriptDocument%3DscriptWindow.document%3Breturn%20scriptDocument.write%28script%29%2CscriptDocument.close%28%29%2CscriptWindow%7DiframeExecute%28script%29%7B%24%28%22%23bbsjs-container%22%29.classList.add%28%22show%22%29%3Bconst%20iframe%3D%24%28%22%23bbsjs-container%20iframe%22%29%3Breturn%20iframe.contentDocument.write%28script%29%2Ciframe.contentDocument.close%28%29%2Ciframe%7D%7D%22undefined%22%21%3Dtypeof%20GM%3FregistJe%28keydown%3D%3E%22J%22%3D%3Dkeydown.key%29%3ApromptJe%28%29%2CassureBbsjsFrame%28%29%3B%7D%28%29" title="bbsjs">小書籤</a></li>
</ul>
<h3 id="blob-url-mime-type">blob url mime type</h3>
<p>chrome 不會把沒指定 <code>content-type</code> 的內容當成 html，
所以改用 File api，並設定型別為 <code>text/html</code> 。</p>
<ul>
<li><a href="https://gist.github.com/GHolk/3154e8486cf987cf6ab84cae45c7dcc7/bc9ed4c3bb9e9448056986335853ec454152b8cf">gist</a></li>
<li><a rel="sidebar" title="bbsjs" href="javascript:void function () {const output=&apos;bookmarklet&apos;;class JavascriptEvalator{prompt(){const script=this.getScript();this.execute(script)}getArticle(){if(location.href.match(&apos;www.ptt.cc&apos;)){return this.getPttWebArticle()}else return this.getPttChromeArticle()}getPttWebArticle(){return $(&apos;#main-container&apos;).text()}getPttChromeArticle(){return $(&apos;#mainContainer&apos;).children().get().map(row=&gt;$(row).text()).join(&apos;\n&apos;)}getScript(){const article=this.getArticle();const html=article.match(/&lt;html[\S\s]*?&lt;\/html&gt;/);const script=article.match(/&lt;script[\S\s]*?&lt;\/script&gt;/);if(html)return html[0];else if(script)return script[0];else throw new Error(&apos;no bbsjs script found&apos;)}execute(script){return this.iframeObjectUrlExecute(script)}iframeObjectUrlExecute(script){const htmlHeader={type:&apos;text/html&apos;};const scriptFile=new File([script],&apos;bbsjs-frame.html&apos;,htmlHeader);const scriptUrl=URL.createObjectURL(scriptFile);$(&apos;#bbsjs-container iframe&apos;).attr(&apos;src&apos;,scriptUrl);URL.revokeObjectURL(scriptFile);$(&apos;#bbsjs-container&apos;).addClass(&apos;show&apos;)}evalExecute(script){const cleanScript=script.replace(/^&lt;script[\S\s]*?&gt;/,&apos;&apos;).replace(/&lt;\/script&gt;$/,&apos;&apos;);return eval(cleanScript)}windowExecute(script){const scriptWindow=window.open(&apos;about:blank&apos;);const scriptDocument=scriptWindow.document;scriptDocument.write(script);scriptDocument.close();return scriptWindow}iframeExecute(script){$(&apos;#bbsjs-container&apos;).addClass(&apos;show&apos;);const iframe=$(&apos;#bbsjs-container iframe&apos;).get(0);iframe.contentDocument.write(script);iframe.contentDocument.close();return iframe}}function promptJe(){const je=new JavascriptEvalator;je.prompt()}function registJe(listen){$(window).keydown(down=&gt;{if(listen(down)){try{promptJe()}catch(bbsjsError){console.error(bbsjsError)}}})}if($(&apos;#bbsjs-container&apos;).length==0)initBbsjsFrame();switch(output){case&apos;hello world&apos;:alert(&apos;hello world!&apos;);break;case&apos;bookmarklet&apos;:promptJe();break;case&apos;user.js&apos;:registJe(keydown=&gt;keydown.key==&apos;J&apos;);break}function initBbsjsFrame(){const $div=$(&apos;&lt;div&gt;&apos;).attr(&apos;id&apos;,&apos;bbsjs-container&apos;);const homePageUrl=&apos;https://gholk.github.io/bbsjs.html&apos;;$(&apos;&lt;button&gt;&apos;).text(&apos;move&apos;).appendTo($div).click(click=&gt;{const $container=$(click.target).parent();$container.toggleClass(&apos;show&apos;)});$(&apos;&lt;a&gt;&apos;).text(&apos;help&apos;).attr(&apos;target&apos;,&apos;bbsjs-iframe&apos;).attr(&apos;href&apos;,homePageUrl).appendTo($div);$(&apos;&lt;iframe&gt;&apos;).attr(&apos;name&apos;,&apos;bbsjs-iframe&apos;).attr(&apos;src&apos;,homePageUrl).appendTo($div);const cssText=`\n#bbsjs-container {\n  transition: 0.5s;\n  position: fixed;\n  top: 1em;\n  left: 1em;\n  z-index: 2;\n  background: white;\n}\n#bbsjs-container * {\n  display: none;\n}\n#bbsjs-container button {\n  display: inline;\n  margin: 0.5em;\n  color: black;\n}\n#bbsjs-container.show iframe {\n  border: none;\n  clear: both;\n  display: block;\n  width: 100%;\n  height: 25em;\n}\n#bbsjs-container.show a {\n  display: inline;\n}\n#bbsjs-container.show {\n  transition: 0.5s;\n  width: 40%;\n  top: 2em;\n  left: 30%;\n  z-index: 2;\n}\n`;$(&apos;&lt;style&gt;&apos;).text(cssText).appendTo($div);$div.appendTo(&apos;body&apos;)}}()">小書籤</a></li>
</ul>
<h3 id="原型說明頁">原型說明頁</h3>
<p>在一開始的 iframe 加入首頁也就是說明頁面，
還加了一個會在 iframe 內開啟的說明頁的超連結。</p>
<ul>
<li><a href="https://gist.github.com/GHolk/3154e8486cf987cf6ab84cae45c7dcc7/112a45b553f0b1989ec2208a8eb09013cfcdad58">gist</a></li>
<li><a rel="sidebar" title="bbsjs" href="javascript:void function () {const output=&apos;bookmarklet&apos;;class JavascriptEvalator{prompt(){const script=this.getScript();this.execute(script)}getArticle(){if(location.href.match(&apos;www.ptt.cc&apos;)){return this.getPttWebArticle()}else return this.getPttChromeArticle()}getPttWebArticle(){return $(&apos;#main-container&apos;).text()}getPttChromeArticle(){return $(&apos;#mainContainer&apos;).children().get().map(row=&gt;$(row).text()).join(&apos;\n&apos;)}getScript(){const article=this.getArticle();const html=article.match(/&lt;html[\S\s]*?&lt;\/html&gt;/);const script=article.match(/&lt;script[\S\s]*?&lt;\/script&gt;/);return html||script}execute(script){return this.iframeObjectUrlExecute(script)}iframeObjectUrlExecute(script){const scriptBlob=new Blob([script]);const scriptUrl=URL.createObjectURL(scriptBlob);$(&apos;#bbsjs-container iframe&apos;).attr(&apos;src&apos;,scriptUrl);URL.revokeObjectURL(scriptBlob);$(&apos;#bbsjs-container&apos;).addClass(&apos;show&apos;)}evalExecute(script){const cleanScript=script.replace(/^&lt;script[\S\s]*?&gt;/,&apos;&apos;).replace(/&lt;\/script&gt;$/,&apos;&apos;);return eval(cleanScript)}windowExecute(script){const scriptWindow=window.open(&apos;about:blank&apos;);const scriptDocument=scriptWindow.document;scriptDocument.write(script);scriptDocument.close();return scriptWindow}iframeExecute(script){$(&apos;#bbsjs-container&apos;).addClass(&apos;show&apos;);const iframe=$(&apos;#bbsjs-container iframe&apos;).get(0);iframe.contentDocument.write(script);iframe.contentDocument.close();return iframe}}function promptJe(){const je=new JavascriptEvalator;je.prompt()}function registJe(listen){$(window).keydown(down=&gt;{if(listen(down)){try{promptJe()}catch(bbsjsError){console.error(bbsjsError)}}})}if($(&apos;#bbsjs-container&apos;).length==0)initBbsjsFrame();switch(output){case&apos;hello world&apos;:alert(&apos;hello world!&apos;);break;case&apos;bookmarklet&apos;:promptJe();break;case&apos;user.js&apos;:registJe(keydown=&gt;keydown.key==&apos;J&apos;);break}function initBbsjsFrame(){const $div=$(&apos;&lt;div&gt;&apos;).attr(&apos;id&apos;,&apos;bbsjs-container&apos;);const homePageUrl=&apos;https://gholk.github.io/bbsjs.html&apos;;$(&apos;&lt;button&gt;&apos;).text(&apos;move&apos;).appendTo($div).click(click=&gt;{const $container=$(click.target).parent();$container.toggleClass(&apos;show&apos;)});$(&apos;&lt;a&gt;&apos;).text(&apos;help&apos;).attr(&apos;target&apos;,&apos;bbsjs-iframe&apos;).attr(&apos;href&apos;,homePageUrl).appendTo($div);$(&apos;&lt;iframe&gt;&apos;).attr(&apos;name&apos;,&apos;bbsjs-iframe&apos;).attr(&apos;src&apos;,homePageUrl).appendTo($div);const cssText=`\n#bbsjs-container {\n  transition: 0.5s;\n  position: fixed;\n  top: 1em;\n  left: 1em;\n  z-index: 2;\n  background: white;\n}\n#bbsjs-container * {\n  display: none;\n}\n#bbsjs-container button {\n  display: inline;\n  margin: 0.5em;\n  color: black;\n}\n#bbsjs-container.show iframe {\n  border: none;\n  clear: both;\n  display: block;\n  width: 100%;\n  height: 25em;\n}\n#bbsjs-container.show a {\n  display: inline;\n}\n#bbsjs-container.show {\n  transition: 0.5s;\n  width: 40%;\n  top: 2em;\n  left: 30%;\n  z-index: 2;\n}\n`;$(&apos;&lt;style&gt;&apos;).text(cssText).appendTo($div);$div.appendTo(&apos;body&apos;)}}()">小書籤</a></li>
</ul>
<h3 id="iframe-原型">iframe 原型</h3>
<p>bbsjs 正式發布友善可用的原型了！
把 bbsjs 在原分頁內用 iframe 載入，
並有按鈕開啟、收合 iframe。</p>
<p>把和有的沒的元素 style 都放在
<code>body &gt; div#bbsjs-container</code> 內，
用了很多 jquery。</p>
<p>目前是用 <code>URL.createObjectURL</code> 和 <code>iframe.src</code> 載入腳本，
因為 grease monkey 的 script 不能寫入 <code>iframe.contentDocument</code> ，
二者被判為不同 origin，只好用這種奇怪的方法。</p>
<ul>
<li><a href="https://gist.github.com/GHolk/3154e8486cf987cf6ab84cae45c7dcc7/e3d4baa929c756a6e2911eb2b25c716975ec22f1">gist</a></li>
<li><a rel="sidebar" title="bbsjs" href="javascript:void function () {const output=&apos;bookmarklet&apos;;class JavascriptEvalator{prompt(){const script=this.getScript();this.execute(script)}getArticle(){if(location.href.match(&apos;www.ptt.cc&apos;)){return this.getPttWebArticle()}else return this.getPttChromeArticle()}getPttWebArticle(){return $(&apos;#main-container&apos;).text()}getPttChromeArticle(){return $(&apos;#mainContainer&apos;).children().get().map(row=&gt;$(row).text()).join(&apos;\n&apos;)}getScript(){const article=this.getArticle();const html=article.match(/&lt;html[\S\s]*?&lt;\/html&gt;/);const script=article.match(/&lt;script[\S\s]*?&lt;\/script&gt;/);return html||script}execute(script){return this.iframeObjectUrlExecute(script)}iframeObjectUrlExecute(script){const scriptBlob=new Blob([script]);const scriptUrl=URL.createObjectURL(scriptBlob);$(&apos;#bbsjs-container iframe&apos;).attr(&apos;src&apos;,scriptUrl);URL.revokeObjectURL(scriptBlob);$(&apos;#bbsjs-container&apos;).addClass(&apos;show&apos;)}evalExecute(script){const cleanScript=script.replace(/^&lt;script[\S\s]*?&gt;/,&apos;&apos;).replace(/&lt;\/script&gt;$/,&apos;&apos;);return eval(cleanScript)}windowExecute(script){const scriptWindow=window.open(&apos;about:blank&apos;);const scriptDocument=scriptWindow.document;scriptDocument.write(script);scriptDocument.close();return scriptWindow}iframeExecute(script){$(&apos;#bbsjs-container&apos;).addClass(&apos;show&apos;);const iframe=$(&apos;#bbsjs-container iframe&apos;).get(0);iframe.contentDocument.write(script);iframe.contentDocument.close();return iframe}}function promptJe(){const je=new JavascriptEvalator;je.prompt()}function registJe(listen){$(window).keydown(down=&gt;{if(listen(down)){try{promptJe()}catch(bbsjsError){console.error(bbsjsError)}}})}if($(&apos;#bbsjs-container&apos;).length==0)initBbsjsFrame();switch(output){case&apos;hello world&apos;:alert(&apos;hello world!&apos;);break;case&apos;bookmarklet&apos;:promptJe();break;case&apos;user.js&apos;:registJe(keydown=&gt;keydown.key==&apos;J&apos;);break}function initBbsjsFrame(){const $div=$(&apos;&lt;div&gt;&apos;).attr(&apos;id&apos;,&apos;bbsjs-container&apos;);$(&apos;&lt;button&gt;&apos;).text(&apos;move&apos;).appendTo($div).click(click=&gt;{const $container=$(click.target).parent();$container.toggleClass(&apos;show&apos;)});$(&apos;&lt;iframe&gt;&apos;).attr(&apos;src&apos;,&apos;https://gholk.github.io/bbsjs.html&apos;).appendTo($div);const cssText=`\n#bbsjs-container {\n  transition: 0.5s;\n  position: fixed;\n  top: 1em;\n  left: 1em;\n  z-index: 2;\n  background: white;\n}\n#bbsjs-container button {\n  float: right;\n  margin: 0.5em;\n  color: black;\n}\n#bbsjs-container iframe {\n  border: none;\n  display: none;\n}\n#bbsjs-container.show iframe {\n  clear: both;\n  display: block;\n  width: 100%;\n  height: 25em;\n}\n#bbsjs-container.show {\n  transition: 0.5s;\n  width: 40%;\n  top: 2em;\n  left: 30%;\n  z-index: 2;\n}\n`;$(&apos;&lt;style&gt;&apos;).text(cssText).appendTo($div);$div.appendTo(&apos;body&apos;)}}()">小書籤</a></li>
</ul>
<h3 id="[分頁原型](bbsjs-prototype-bookmarklet-user-js.txt)"><a href="bbsjs-prototype-bookmarklet-user-js.txt">分頁原型</a></h3>
<p>bbsjs 會在新開的頁面載入。這本的 user.js 不能用，
後來發現是下一版 iframe 原型那個 same origin 的雷，
<code>*.user.js</code> 和原本頁面不是 same origin。</p>
<ul>
<li><a href="https://gist.github.com/GHolk/3154e8486cf987cf6ab84cae45c7dcc7/52642d32989748e6e88d20d96fcddc79cd08e21c">gist</a></li>
<li><a title="bbsjs" rel="sidebar" href="javascript:void function () {const output=&apos;bookmarklet&apos;;class FakePrint{constructor(string){if(string)this.data=string;else this.data=&apos;&apos;}print(string){this.data+=string}println(string){this.print(string+&apos;\n&apos;)}}class JavascriptEvalator{prompt(){const script=this.getScript();this.execute(script)}getArticle(){if(location.href.match(&apos;www.ptt.cc&apos;)){return this.getPttWebArticle()}else return this.getPttChromeArticle()}getPttWebArticle(){return $(&apos;#main-container&apos;).text()}getPttChromeArticle(){return $(&apos;#mainContainer&apos;).children().get().map(row=&gt;$(row).text()).join(&apos;\n&apos;)}getScript(){const article=this.getArticle();const html=article.match(/&lt;html[\S\s]*?&lt;\/html&gt;/);const script=article.match(/&lt;script[\S\s]*?&lt;\/script&gt;/);return html||script}execute(script){return this.windowExecute(script)}evalExecute(script){const cleanScript=script.replace(/^&lt;script[\S\s]*?&gt;/,&apos;&apos;).replace(/&lt;\/script&gt;$/,&apos;&apos;);return eval(cleanScript)}windowExecute(script){const scriptWindow=window.open(&apos;about:blank&apos;);const scriptDocument=scriptWindow.document;scriptDocument.write(script);scriptDocument.close();return scriptWindow}}function promptJe(){const je=new JavascriptEvalator;je.prompt()}function registJe(listen){window.addEventListener(&apos;keydown&apos;,down=&gt;{if(listen(down)){try{promptJe()}catch(evalError){throw evalError}}})}switch(output){case&apos;hello world&apos;:alert(&apos;hello world!&apos;);break;case&apos;bookmarklet&apos;:promptJe();break;case&apos;user.js&apos;:registJe(keydown=&gt;keydown.key==&apos;J&apos;);break}}()">小書籤</a></li>
</ul>
<h2 id="BBSLua">BBSLua</h2>
<p>以前 ptt 有一個在文章內嵌入 lua 程式，
讓使用者可以執行 lua 互動。
目前在 ptt2 可以使用 bbslua，
但因為 lua 還是要在 ptt 伺服器上執行，
考量效能 ptt1 負載已經很重，就沒有引進到 ptt1。</p>
<p>如果是 javascirpt 就能在瀏覽器上執行，不會再增加 ptt 負擔。
而且現在用瀏覽器上 ptt 的人數也增加了，
像 BBSFOX 或 ptt chrome，甚至 ptt 官方也開放用 websocket
從 <a href="https://term.ptt.cc/">https://term.ptt.cc/</a> 上 ptt。
安裝 bbsjs 後，就能直接在瀏覽器上執行 bbsjs。</p>
<h2 id="問題回報與討論">問題回報與討論</h2>
<p>如果要報 bug 或提功能建議，可以在本文下面的 discus 留言板討論，
disqus 如果不想註冊，可以匿名評論。
或是在 <a href="http://github.com/GHolk/bookmarklet/blob/master/bbsjs.user.js">bbsjs 的 github repository</a> 開 issue、發 pull request。</p>
</main>

<script defer src="ext/meta-meta.js"></script>
<script defer src="ext/load-disqus.js"></script>





</body></html>
